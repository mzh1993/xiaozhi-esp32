### 目标

- 解决双耳电机同时启动导致 VSYS 下坠→3.3V 跌落→ESP32 Brownout 的问题。
- 优先使用软件“削峰填谷”：错峰启动（已实现），软启动接口（已预留，默认关闭）。
- 保持现有情绪序列行为尽量一致。

### 已实施改动

1) 在 `main/ear/tc118s_ear_controller.h` 增加配置宏（可调）：

```c++
#define EAR_POWER_ON_STABILIZE_MS   150   // 板级参考值
#define EAR_START_STAGGER_MS        80    // 双耳启动错峰间隔（毫秒）

#define EAR_SOFTSTART_ENABLE        0     // 软启动默认关闭
#define EAR_SOFTSTART_TIME_MS       200   // 软启动总时长
#define EAR_SOFTSTART_STEPS         8     // 软启动步数
```

2) 在 `main/ear/tc118s_ear_controller.cc`：

- 对“双耳同时动作”的组合（`EAR_COMBO_BOTH_FORWARD/BACKWARD`）引入“异步错峰启动”：
  - 新增 `StartBothWithStagger(ear_combo_action_t, uint32_t)`，使用独立任务先启动左耳，延迟 `EAR_START_STAGGER_MS` 后再启动右耳，避免在定时器服务任务中阻塞。
  - 保持原有 `stop_timer_` 非阻塞停止逻辑不变。
- 预留 `SoftStartSingleEar(bool, ear_action_t)` 接口：
  - 现阶段在 `EAR_SOFTSTART_ENABLE=0` 时等同于直接 GPIO 启动；后续若需要可在该方法中接入 LEDC PWM 占空比渐升实现真正软启动。

变更入口示例（节选）：

```c++
// 在 MoveBoth 中：
case EAR_COMBO_BOTH_FORWARD:
case EAR_COMBO_BOTH_BACKWARD:
    StartBothWithStagger(combo.combo_action, combo.duration_ms);
    break;
```

### 参数建议

- `EAR_START_STAGGER_MS`：80ms 起步；如仍有偶发 Brownout，可调至 100–120ms。
- 若需要进一步降低峰值：开启软启动（将 `EAR_SOFTSTART_ENABLE` 置为 1），并将 `EAR_SOFTSTART_TIME_MS` 设为 200–250ms，`EAR_SOFTSTART_STEPS` 8–12。

### 可选的温和节奏微调（若仍不稳定）

文件：`main/ear/tc118s_ear_controller.h`

- 将以下宏适度增大（每次只改一项做 A/B）：
  - `#define EAR_MOVE_FAST_MS 55` → 65–75
  - `#define EAR_PAUSE_SHORT_MS 100` → 120–150

对“excited/angry”等高强度序列的首步可由 FAST 改为 QUICK/MEDIUM 以进一步减峰。

### 板级稳定等待（复核）

文件：`main/boards/astronaut-toys-esp32s3/astronaut-toys-esp32s3.cc`

- `InitializeEarController()` 中在拉高 `EAR_MOTO_EN_GPIO` 后已延时 `vTaskDelay(pdMS_TO_TICKS(150));`，实测若 DCDC 建立更慢，可调至 200–300ms。

### 测试用例

1) 基线：开机静置 2 分钟，确认无 Brownout。
2) 序列压力：循环触发 `excited/angry/playful` 各 30 次，确认无复位。
3) 触摸并发：头/鼻/肚子点击与长按交替 2 分钟，确认稳定。
4) 网络/音频并发：Wi-Fi 连接/断开切换 + 说话/监听状态切换 + 耳朵序列并发运行，确认稳定。
5) 若可测量：用示波器观察 `VSYS`、`5V_DCDC_IN/OUT`，比较改动前后电压跌落改善。

通过标准：10–20 分钟连续压测无 Brownout/复位；VSYS 跌落幅度明显降低且不触发 BOD 阈值。

### 回退策略

- 关闭软启动：`#define EAR_SOFTSTART_ENABLE 0`
- 关闭错峰：将 `#define EAR_START_STAGGER_MS 0`

### 硬件改进（下一版推荐）

- 在 `VSYS` 近 DCDC 输入端并联 220–470µF 低 ESR 电容；就近布局、回流地短直。
- 加粗电源路径，减少压降与寄生电感。
- 评估 DCDC 器件瞬态响应能力，必要时更换更强开关电流/响应型号。

---

如需，我可以继续实现 LEDC PWM 软启动（开启 `EAR_SOFTSTART_ENABLE`），并提供一键配置与测试脚本。 


