# 系统整体调度优化方案文档

基于《触摸事件语音播报失败问题分析.md》的结论，提出系统级调度优化方案，以提升音频首包可靠性、降低模块间竞态、并改善功耗与可维护性。

## 1. 目标与范围
- 音频回放首包可靠、可预期：消除“有文本无音频”的偶发情况。
- 降低多源调度导致的时序不确定性：统一任务/定时器管理。
- 降低 Timer Service 负载与阻塞风险：定时器回调零阻塞。
- 保障音频/网络关键路径优先级：不被外设（耳朵马达）干扰。

适用范围：`main/application.*`、`main/audio/*`、`main/protocols/*`、`main/ear/*`、板级 `AudioCodec` 实现。

## 2. 当前主要问题（摘要）
- 触摸链路：发送 `listen+detect` 后立即 `listen+start` 易与服务端期望冲突，导致不下发音频；随后命中自动省电关断，形成“启用→等待→关断”。
- FreeRTOS 使用分散：App 与 Ear 各自使用任务/定时器/互斥，Timer Service 回调与主状态机/协议回调时序交叠，增加不确定性。
- 电源策略耦合松散：`AUDIO_POWER_TIMEOUT_MS` 基于“最后播放时间”，在无首包期间会误关；部分板级还存在一次性关断定时器。

## 3. 设计原则
1) 中心化调度：核心任务只在 App/Audio/Protocol 层创建，外设模块尽量不新建任务。
2) 关键路径优先：音频编解码/网络回调的优先级高于外设动作。
3) 定时回调零阻塞：定时器回调只做事件投递，不做耗时/阻塞调用。
4) 状态机一致：跨模块状态迁移由 App 主循环串行化，减少竞态。
5) 省电策略可感知会话：speaking 期间抑制自动关断；收到 `tts start` 立即刷新首包等待计时。

## 4. 任务与优先级规划（建议）
优先级从高到低（示意）：
1. 协议网络回调 / UDP 音频接收（Protocol 内部回调，不单独任务时由网络栈线程承载）
2. Opus 编解码任务（`AudioService::OpusCodecTask`）
3. 音频输出任务（`AudioService::AudioOutputTask`）与输入任务（可与 Processor 共用）
4. App 主事件循环（`MainEventLoop`）
5. 外设 Worker Task（耳朵、灯光等统一工作队列）
6. UI 及低优先级服务

说明：具体数值按现有系统优先级表调整，但需保证 1-3 > 4 > 5。

## 5. 外设（耳朵）调度改造
- 统一 Worker Task：在 App 创建一个“外设工作任务”，Ear 通过队列提交“动作事件”。
- 单定时器推进序列：Ear 仅保留一根软件定时器维护状态机；回调中只投递“下一步动作”到 Worker，不直接操控 GPIO/阻塞。
- 互斥最小化：仅保护共享标志（如 `sequence_active_`、`emotion_action_active_`、`moving_both_`），避免跨模块大锁。
- 状态协同：情绪触发/触摸触发均经 App 主循环判定（例如 speaking 首包窗口期延后大动作，降低电源波动与时序抖动）。

## 6. 触摸链路优化（关键）
- 去监听化：触摸路径不立即 `SetListeningMode`。流程调整为：
  1) 打开音频通道（如需）；
  2) 发送 `listen+detect`（触摸文本）；
  3) 等待服务端 `tts start` → 切 `speaking`；
  4) 若超时未收到 `tts start`，再按策略进入 listening 或提示失败。
- speaking 期间保护：进入 speaking 即 `EnableOutput(true)`；同时抑制自动关断（见第 7 节）。

## 7. 音频电源与首包保护
- Speaking 期间抑制自动关断：
  - 在 `device_state_ == speaking` 时，`CheckAndUpdateAudioPowerState()` 不关闭输出；或将 `AUDIO_POWER_TIMEOUT_MS` 动态拉长（如 60s）。
- 刷新首包计时：
  - 收到 `tts start` 即刷新 `last_output_time_`，为首包到达预留缓冲时间。
- 板级一次性关断协调：
  - 若板级实现（如 `AdcPdmAudioCodec`）有一次性关断定时器，在 speaking 期间延后或禁用；由 `AudioService` 统一负责输出状态。

## 8. Timer Service 负载控制
- 耳朵序列尽量使用单定时器 + 改期（`xTimerChangePeriod`）。
- 定时器回调仅投递轻量事件到 Worker（可用 `xTimerPendFunctionCall`）。
- 严禁定时器回调里：`vTaskDelay`、阻塞 I/O、重计算、跨模块调用。

## 9. 协议/音频回调一致性
- `OnIncomingAudio` 与 MQTT/WebSocket 回调内仅做队列投递，避免重逻辑。
- App 状态机的切换只在主循环中执行。
- 对 `goodbye` 等通道关闭消息：speaking 或最近 `tts start` 的 5s 窗口内优先尝试重开通道并维持输出开启。

## 10. 监控与回退
- 首包监控：统计“`tts start` → 首个 UDP 包到达”耗时，超阈值打印一次（仅调试版）。
- 失败回退：若触摸链路 2-3 次连续超时，临时启用“触摸→直接 speaking 保护模式”（跳过 listen+start），以提高可用性。

## 11. 实施计划（建议分阶段）
阶段 A（快速止血，1-2 天）：
- 触摸链路去监听化，speaking 期间抑制自动关断，`tts start` 刷新 `last_output_time_`。

阶段 B（结构优化，3-5 天）：
- 引入外设 Worker Task，Ear 改为单定时器 + 事件投递；清理耳朵回调中的潜在阻塞与跨模块调用。
- 校准任务优先级，确保音频/网络关键路径高优先级。

阶段 C（完善与验证，3-5 天）：
- 板级一次性关断与 AudioService 策略对齐；
- 增加首包监控、失败回退机制；
- 压测：开机首次触摸、连续触摸/唤醒、弱网/丢包下的回放可靠性。

## 12. 预期收益
- 首包可用性显著提升，触摸/唤醒路径行为一致。
- Timer Service 压力降低，竞态与时序抖动减少。
- 架构职责清晰，便于后续维护与扩展（新增外设按统一模式接入）。

---
该方案兼顾“快速止血”与“结构改良”，优先保障音频/网络关键路径的实时性与稳定性，再逐步把外设并发行为收敛到统一调度模型下。


