# ESP-SPOT开发板电源管理设计

## 1. 电源模式状态机

### 1.1 系统工作状态

系统有三种工作状态:

| 状态 | 说明 | MCU_VCC_CTL | PREP_VCC_CTL |
|------|------|-------------|---------------|
| Active | 正常工作状态 | 1 | 1 |
| Deep Sleep | MCU低功耗状态 | 1 | 0 |
| Power Down | 完全断电状态 | 0 | 0 |

### 1.2 状态转换触发条件

- Active → Deep Sleep
  - 通过按键(Key)触发
  - IMU中断触发
  - 超时/音频命令触发

- Deep Sleep → Active
  - 通过按键(Key)唤醒
  - IMU中断唤醒

- Deep Sleep → Power Down
  - 电池电量低时自动进入

- Power Down → Active
  - 通过按键(Key)唤醒

## 2. 供电电路设计

供电电路包含两个关键部分:

### 2.1 POWER SWITCH电路

- SW3（TS-1088-AR02016）是点动开关
- KEY按键连接到ESP32的IO12
- MCU_VCC_CTL连接到IO4

POWER_EN信号拉高条件(任一满足):
- USB供电(VBUS)存在
- KEY按键被按下
- MCU_VCC_CTL引脚输出高电平

### 2.2 CODEC电源控制电路

- PREP_VCC_CTL（IO6）控制CODEC_3V3供电
- 使用电压调节器（U14）将VIN转换为CODEC_3V3
- PREP_VCC_CTL为高电平时音频编解码器工作


## 3. PowerSaveTimer 模块分析

### 3.1 模块概述

PowerSaveTimer是电源管理的核心模块，基于ESP-IDF的定时器实现，主要功能包括：

1. 监控系统活跃状态，在空闲时自动降低系统功耗
2. 在超时无操作后自动进入休眠模式
3. 提供休眠模式与唤醒机制
4. 支持完全关机功能(可选)

### 3.2 关键参数

PowerSaveTimer构造函数接收三个主要参数：

```cpp
PowerSaveTimer(int cpu_max_freq, int seconds_to_sleep, int seconds_to_shutdown);
```

- `cpu_max_freq`: CPU最大工作频率(MHz)，-1表示不管理CPU频率
- `seconds_to_sleep`: 空闲多少秒后进入休眠模式，-1表示禁用自动休眠
- `seconds_to_shutdown`: 空闲多少秒后关机，-1表示禁用自动关机

### 3.3 工作流程

1. **初始化阶段**
   - 创建定时器，每秒触发一次
   - 定义回调函数用于电源状态检查

2. **运行阶段**
   - 通过调用`SetEnabled(true)`启用电源管理
   - 定时器每秒递增一次计数(`ticks_`)
   - 检查应用程序是否可以进入休眠模式(`CanEnterSleepMode()`)

3. **进入休眠模式**
   - 当计数达到`seconds_to_sleep`
   - 触发`on_enter_sleep_mode_`回调
   - 调整CPU频率和电源模式：
     ```cpp
     esp_pm_config_t pm_config = {
         .max_freq_mhz = cpu_max_freq_,
         .min_freq_mhz = 40,            // 最低40MHz
         .light_sleep_enable = true,    // 启用轻度睡眠
     };
     esp_pm_configure(&pm_config);
     ```

4. **退出休眠模式**
   - 调用`WakeUp()`方法
   - 重置计数器，恢复正常CPU频率：
     ```cpp
     esp_pm_config_t pm_config = {
         .max_freq_mhz = cpu_max_freq_,
         .min_freq_mhz = cpu_max_freq_, // 最低频率等于最高频率，禁用DFS
         .light_sleep_enable = false,    // 禁用轻度睡眠
     };
     ```
   - 触发`on_exit_sleep_mode_`回调

5. **自动关机**
   - 当计数达到`seconds_to_shutdown`
   - 触发`on_shutdown_request_`回调

### 3.4 实际应用配置

ESP-SparkSpot板的电源管理配置：

```cpp
power_save_timer_(-1, 60, 300)
```

- 不管理CPU频率(使用默认值)
- 60秒无操作后进入休眠模式
- 300秒(5分钟)无操作后进入关机状态

在休眠模式下：
- 关闭音频编解码器电源(PREP_VCC_CTL = 0)
- MCU继续运行(MCU_VCC_CTL = 1)
- 系统处于低功耗模式，但可以响应中断

### 3.5 回调函数设计

PowerSaveTimer提供三个关键回调接口：

1. **OnEnterSleepMode**
   - 进入休眠前执行
   - 用于关闭不必要的外设(如音频编解码器)
   
2. **OnExitSleepMode**
   - 退出休眠时执行
   - 用于恢复外设工作状态
   
3. **OnShutdownRequest**
   - 关机请求时执行
   - 可执行保存状态、安全关断等操作

### 3.6 唤醒机制

系统可通过以下方式唤醒：

1. 按键中断：按下KEY按键触发GPIO中断
2. 显式调用WakeUp()方法：如通过touch按键触发唤醒
3. 其他外部中断：如IMU移动检测中断

### 3.7 注意事项

1. 电源管理依赖ESP-IDF的电源管理组件，需确保在menuconfig中正确配置
2. 休眠模式下的耗电量取决于保持开启的外设和唤醒源
3. 系统稳定性需要确保所有外设在休眠和唤醒时正确初始化
4. 按键唤醒时需配置为中断模式，否则无法从深度休眠中唤醒

## 4. 完整电源管理流程

1. **开机时序**：
   - KEY按下 → MCU启动并配置IO4(MCU_VCC_CTL)为高电平 → POWER_EN信号保持高电平
   - 初始化电源管理模块，设置计时器和回调函数
   - 启用音频模块，将IO6(PREP_VCC_CTL)设为高电平

2. **活跃状态**：
   - PowerSaveTimer持续监控系统活动
   - 每次用户交互或系统活动重置计时器计数

3. **进入休眠**：
   - 60秒无操作 → PowerSaveTimer触发OnEnterSleepMode回调
   - 关闭音频编解码器(PREP_VCC_CTL=0)
   - 系统进入低功耗模式，但保持MCU运行(MCU_VCC_CTL=1)

4. **唤醒过程**：
   - KEY按键按下或IMU中断触发 → 调用WakeUp()
   - 触发OnExitSleepMode回调，恢复音频电源(PREP_VCC_CTL=1)
   - 系统恢复正常工作状态

5. **关机处理**：
   - 超过5分钟无操作或检测到电池电量低
   - 触发OnShutdownRequest回调
   - 关闭所有外设，MCU_VCC_CTL置低，系统完全断电