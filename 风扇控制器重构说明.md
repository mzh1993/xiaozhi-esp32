# 风扇控制器重构说明

## 重构目标

将原本分离的档位控制和百分比控制统一为基于百分比的统一接口，简化状态管理和控制逻辑。

## 主要改进

### 1. 统一状态管理

**重构前：**
```cpp
std::atomic<FanSpeed> current_speed_{FanSpeed::OFF};  // 仅在档位控制时更新
std::atomic<uint8_t> current_percentage_{0};          // 实际PWM输出百分比
```

**重构后：**
```cpp
std::atomic<uint8_t> current_percentage_{0};          // 统一的状态管理
```

### 2. 简化命令枚举

**重构前：**
```cpp
enum class FanCommand {
    TURN_OFF,
    SET_LOW,        // 50%
    SET_MEDIUM,     // 75%
    SET_HIGH,       // 100%
    NEXT_SPEED,     // 下一个档位
    SET_PERCENTAGE, // 设置百分比
    EMERGENCY_STOP
};
```

**重构后：**
```cpp
enum class FanCommand {
    TURN_OFF,           // 关闭风扇
    SET_PERCENTAGE,     // 设置百分比 (0-100)
    NEXT_LEVEL,         // 下一个档位 (按键专用)
    EMERGENCY_STOP      // 紧急停止
};
```

### 3. 统一控制接口

**核心接口：**
```cpp
// 统一控制接口 - 基于百分比
void TurnOff();                                    // 关闭风扇
void SetPercentage(uint8_t percentage);            // 设置百分比 (0-100)
void NextLevel();                                  // 下一个档位 (按键专用)
void EmergencyStop();                              // 紧急停止

// 便捷接口 - 基于档位
void SetLowSpeed();                                // 设置为低档 (50%)
void SetMediumSpeed();                             // 设置为中档 (75%)
void SetHighSpeed();                               // 设置为高档 (100%)
```

### 4. 档位配置

**重构前：**
```cpp
static constexpr uint8_t SPEED_LOW_PERCENT = 50;      // 低档位百分比
static constexpr uint8_t SPEED_MEDIUM_PERCENT = 75;   // 中档位百分比
static constexpr uint8_t SPEED_HIGH_PERCENT = 100;    // 高档位百分比
```

**重构后：**
```cpp
static constexpr uint8_t SPEED_LEVELS[] = {0, 50, 75, 100};  // 关闭、低、中、高
static constexpr uint8_t SPEED_LEVEL_COUNT = 4;
```

## 控制逻辑统一

### 手动按键控制
- 按键按下：调用 `NextLevel()` 
- 长按：调用 `EmergencyStop()`
- 档位切换：0% → 50% → 75% → 100% → 0%

### 语音控制
- "关闭/关" → `SetPercentage(0)`
- "低风/小风" → `SetPercentage(50)`
- "中风" → `SetPercentage(75)`
- "高风/大风" → `SetPercentage(100)`
- "下一档" → `NextLevel()`
- "XX%" → `SetPercentage(XX)`

### MCP工具接口
- `self.fan.get_state` - 获取状态
- `self.fan.set_percentage` - 设置百分比
- `self.fan.set_level` - 设置档位
- `self.fan.next_level` - 下一档位
- `self.fan.emergency_stop` - 紧急停止

## 状态查询接口

```cpp
bool IsPowerOn() const;                    // 是否开启
uint8_t GetCurrentPercentage() const;      // 当前百分比
uint8_t GetCurrentLevel() const;           // 当前档位索引 (0-3)
std::string GetCurrentLevelName() const;   // 当前档位名称
```

## 优势

1. **逻辑统一**：所有控制都基于百分比，避免状态不一致
2. **接口简化**：减少重复代码，提高可维护性
3. **扩展性好**：可以轻松添加新的档位或修改百分比
4. **状态清晰**：只有一个状态变量，避免同步问题
5. **向后兼容**：保留原有的便捷接口

## 使用示例

```cpp
// 创建控制器
FanController fan(GPIO_NUM_0, GPIO_NUM_1, LEDC_CHANNEL_0);

// 设置控制模式
fan.SetControlMode(FanControlMode::ONLINE);  // 语音控制模式

// 百分比控制
fan.SetPercentage(60);  // 设置为60%

// 档位控制
fan.SetLowSpeed();      // 设置为低档 (50%)
fan.NextLevel();        // 切换到下一档

// 状态查询
uint8_t percent = fan.GetCurrentPercentage();  // 获取当前百分比
std::string level = fan.GetCurrentLevelName(); // 获取档位名称
```
