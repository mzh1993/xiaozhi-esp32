# 持续时间监控日志功能说明

## 功能概述

已添加详细的持续时间监控日志，用于验证耳朵动作的实际执行时间是否符合预期。

## 已添加的日志点

### 1. 情绪序列加载日志（InitializeDefaultEmotionMappings）

**位置**: `tc118s_ear_controller.cc:807-818`

**日志内容**:
- 每个情绪序列加载时打印所有步骤信息
- 包括：步骤序号、动作类型、持续时间、延迟时间

**日志级别**: `LOGD`（调试级别）

**示例**:
```
[D] TC118S_EAR_CONTROLLER: [EMOTION] Loaded emotion 'happy' with 4 steps
[D] TC118S_EAR_CONTROLLER: [EMOTION]   Step 1: action=0, duration=65 ms, delay=150 ms
[D] TC118S_EAR_CONTROLLER: [EMOTION]   Step 2: action=1, duration=65 ms, delay=150 ms
```

### 2. 情绪触发日志（TriggerEmotion）

**位置**: `tc118s_ear_controller.cc:771-779`

**日志内容**:
- 触发情绪时打印序列信息
- 验证序列数据是否正确传递

**日志级别**: `LOGI`（信息级别）

**示例**:
```
[I] TC118S_EAR_CONTROLLER: [EMOTION] Triggering emotion 'happy' with 4 steps
[I] TC118S_EAR_CONTROLLER: [EMOTION]   Step 1: action=0, duration=65 ms, delay=150 ms
```

### 3. 序列加载日志（PlaySequence）

**位置**: `tc118s_ear_controller.cc:686-692`

**日志内容**:
- 序列开始播放时打印所有步骤
- 验证序列数据是否正确加载到 `current_sequence_`

**日志级别**: `LOGD`（调试级别）

**示例**:
```
[D] TC118S_EAR_CONTROLLER: [SEQUENCE] Load step 1: action=0, duration=65 ms, delay=150 ms
```

### 4. 序列步骤执行日志（OnSequenceTimer）

**位置**: `tc118s_ear_controller.cc:826-828`

**日志内容**:
- 每个序列步骤执行时打印步骤信息
- 包括：步骤序号/总数、动作类型、持续时间、延迟时间、执行时间戳

**日志级别**: `LOGI`（信息级别）

**示例**:
```
[I] TC118S_EAR_CONTROLLER: [SEQUENCE] Step 1/4: action=0, duration=65 ms, delay=150 ms, at=123456 ms
```

### 5. 动作切换日志（MoveBoth）

**位置**: `tc118s_ear_controller.cc:519-527`

**日志内容**:
- 动作切换时打印上一个动作的实际执行时间
- 如果动作被提前中断，记录警告

**日志级别**: `LOGI` / `LOGW`（信息/警告级别）

**示例**:
```
[I] TC118S_EAR_CONTROLLER: [DURATION] Action change: 0 -> 1, previous action elapsed=30 ms
[W] TC118S_EAR_CONTROLLER: [DURATION] Action interrupted: elapsed=30 ms < scheduled=65 ms (short by 35 ms)
```

### 6. GPIO 设置时间日志（StartBothWithStagger）

**位置**: `tc118s_ear_controller.cc:1273-1274`

**日志内容**:
- 记录 GPIO 实际设置的时间戳
- 用于计算实际执行时间

**日志级别**: `LOGD`（调试级别）

**示例**:
```
[D] TC118S_EAR_CONTROLLER: [DURATION] GPIO set at: 123456 ms, scheduled duration: 65 ms
```

### 7. 停止定时器调度日志（ScheduleComboStop）

**位置**: `tc118s_ear_controller.cc:1221-1229`

**日志内容**:
- 记录停止定时器的启动时间
- 用于验证定时器是否准时触发

**日志级别**: `LOGD`（调试级别）

**示例**:
```
[D] TC118S_EAR_CONTROLLER: [DURATION] Stop timer scheduled at: 123456 ms, duration: 65 ms
```

### 8. 停止定时器触发日志（OnStopTimer / OnEarComboStopTimeout）

**位置**: 
- `tc118s_ear_controller.cc:1175-1176`
- `application.cc:995`

**日志内容**:
- 记录停止定时器触发的时间戳
- 计算定时器延迟误差

**日志级别**: `LOGI` / `LOGD`（信息/调试级别）

**示例**:
```
[I] TC118S_EAR_CONTROLLER: [DURATION] Stop timer triggered: scheduled=65 ms, actual_delay=66 ms, error=1 ms
```

### 9. 动作持续时间验证日志（StopBoth）

**位置**: `tc118s_ear_controller.cc:434-447`

**日志内容**:
- 计算并打印实际执行时间
- 与计划持续时间对比
- 如果误差超过 5ms，记录警告
- 如果误差超过 20%，记录警告

**日志级别**: `LOGI` / `LOGW`（信息/警告级别）

**示例**:
```
[I] TC118S_EAR_CONTROLLER: [DURATION] Action duration: scheduled=65 ms, actual=66 ms, error=1 ms (action=0)
[W] TC118S_EAR_CONTROLLER: [DURATION] Action duration mismatch: scheduled=65 ms, actual=80 ms, error=15 ms (action=0)
[W] TC118S_EAR_CONTROLLER: [DURATION] Large duration error: 23% (action=0, scheduled=65 ms, actual=80 ms)
```

### 10. 序列动作重叠检测日志（OnSequenceTimer）

**位置**: `tc118s_ear_controller.cc:834-836`

**日志内容**:
- 检测上一个动作是否还在执行
- 如果序列步骤提前到达，记录警告

**日志级别**: `LOGW`（警告级别）

**示例**:
```
[W] TC118S_EAR_CONTROLLER: [SEQUENCE] Previous action still running: elapsed=30 ms, scheduled=65 ms (interrupted)
```

## 日志标签说明

所有持续时间相关的日志都使用 `[DURATION]` 或 `[SEQUENCE]` 标签，便于过滤和分析。

## 如何使用

### 查看所有持续时间日志

```bash
idf.py monitor | grep -E "\[DURATION\]|\[SEQUENCE\]"
```

### 查看警告日志（持续时间误差）

```bash
idf.py monitor | grep -E "\[DURATION\].*mismatch|\[DURATION\].*error|\[DURATION\].*interrupted"
```

### 查看序列执行流程

```bash
idf.py monitor | grep -E "\[SEQUENCE\]|\[EMOTION\]"
```

## 发现的问题

从当前的日志输出看，存在以下问题：

1. **持续时间显示异常**：日志显示 `duration=0 ms` 或 `duration=1 ms`，但序列定义中应该是 55-65ms
   - 可能原因：格式化字符串问题或数据结构问题
   
2. **格式化字符串未生效**：日志显示 `at=lu ms` 和 `Step 1/zu`，说明 `PRIu64` 格式可能未生效
   - 建议：重新编译固件

3. **动作类型超出范围**：日志显示 `action=6`，但有效范围应该是 0-5
   - 可能原因：内存损坏或数据传递问题

## 下一步调试建议

1. **重新编译并刷写固件**，确保格式化字符串修复生效
2. **查看初始化日志**，验证序列数据是否正确加载
3. **分析持续时间误差**，找出问题根源
4. **检查内存对齐**，确保数据结构没有对齐问题

---

**实施日期**: 2025-01-XX  
**状态**: ✅ 已完成  
**待验证**: 需要重新编译并测试日志输出
