# 风扇控制器使用说明

## 1. 硬件连接

### 1.1 基于ASK788芯片的风扇电路连接

```
ESP32 GPIO17 ──→ ASK788 KEY引脚
ESP32 GND   ──→ ASK788 GND引脚  
ESP32 BAT   ──→ ASK788 BAT引脚
```

### 1.2 电源连接
- ESP32与风扇电路共用BAT电源
- 确保共地连接，保证信号电平一致

## 2. 软件功能

### 2.1 注册的MCP工具

FanController注册了以下5个MCP工具：

#### 2.1.1 获取风扇状态
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "self.fan.get_state",
    "arguments": {}
  },
  "id": 1
}
```
**返回值**: `{"power": true, "speed": "medium"}`

#### 2.1.2 开启风扇
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "self.fan.turn_on",
    "arguments": {}
  },
  "id": 2
}
```
**功能**: 以低档速度开启风扇

#### 2.1.3 关闭风扇
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "self.fan.turn_off",
    "arguments": {}
  },
  "id": 3
}
```
**功能**: 完全关闭风扇

#### 2.1.4 设置风扇档位
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "self.fan.set_speed",
    "arguments": {
      "speed": 2
    }
  },
  "id": 4
}
```
**参数说明**:
- `speed`: 0=关闭, 1=低档, 2=中档, 3=高档

#### 2.1.5 切换档位
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "self.fan.next_speed",
    "arguments": {}
  },
  "id": 5
}
```
**功能**: 按顺序切换档位 (关闭→低档→中档→高档→关闭)

## 3. 控制原理

### 3.1 ASK788芯片控制方式

根据芯片文档说明，ASK788芯片通过KEY引脚接收**连续点击**来控制风扇档位切换：

- **每次点击**: 按顺序切换档位 (低档→中档→高档→关断→低档...)
- **点击时序**: 按下50ms，释放100ms，确保芯片正确识别
- **PWM输出**: 芯片内部以70Hz频率输出PWM信号，占空比随档位变化

### 3.2 GPIO控制实现

```cpp
void SetSpeed(FanSpeed target_speed) {
    // 计算从当前档位到目标档位需要的点击次数
    int clicks_needed = 0;
    
    // 根据当前档位和目标档位计算点击次数
    switch (current_speed_) {
        case FanSpeed::OFF:
            switch (target_speed) {
                case FanSpeed::LOW: clicks_needed = 1; break;
                case FanSpeed::MEDIUM: clicks_needed = 2; break;
                case FanSpeed::HIGH: clicks_needed = 3; break;
            }
            break;
        case FanSpeed::LOW:
            switch (target_speed) {
                case FanSpeed::OFF: clicks_needed = 3; break; // 低->中->高->关
                case FanSpeed::MEDIUM: clicks_needed = 1; break;
                case FanSpeed::HIGH: clicks_needed = 2; break;
            }
            break;
        // ... 其他档位切换逻辑
    }
    
    // 执行连续点击
    for (int i = 0; i < clicks_needed; i++) {
        gpio_set_level(gpio_num_, 1);  // 按下
        vTaskDelay(pdMS_TO_TICKS(50)); // 按下50ms
        gpio_set_level(gpio_num_, 0);  // 释放
        vTaskDelay(pdMS_TO_TICKS(100)); // 释放100ms
    }
}
```

### 3.3 档位切换逻辑

ASK788芯片的档位切换遵循以下循环：
```
关断 → 低档 → 中档 → 高档 → 关断 → ...
```

每次点击KEY引脚，风扇会按顺序切换到下一个档位。因此：

- **从关断到低档**: 需要1次点击
- **从关断到中档**: 需要2次点击 (关断→低档→中档)
- **从关断到高档**: 需要3次点击 (关断→低档→中档→高档)
- **从低档到关断**: 需要3次点击 (低档→中档→高档→关断)

这种设计确保了无论当前处于哪个档位，都能通过计算需要的点击次数来达到目标档位。

## 4. 测试步骤

### 4.1 硬件测试
1. 连接ESP32 GPIO17到ASK788的KEY引脚
2. 确保电源和地线正确连接
3. 上电测试风扇是否正常工作

### 4.2 软件测试
1. 编译并烧录程序到ESP32
2. 通过MCP协议调用工具进行测试：

```bash
# 测试开启风扇
curl -X POST http://device-ip/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "tools/call",
    "params": {
      "name": "self.fan.turn_on",
      "arguments": {}
    },
    "id": 1
  }'

# 测试设置高档
curl -X POST http://device-ip/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "tools/call",
    "params": {
      "name": "self.fan.set_speed",
      "arguments": {
        "speed": 3
      }
    },
    "id": 2
  }'

# 测试获取状态
curl -X POST http://device-ip/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "tools/call",
    "params": {
      "name": "self.fan.get_state",
      "arguments": {}
    },
    "id": 3
  }'
```

## 5. 故障排除

### 5.1 风扇不响应
- 检查GPIO连接是否正确
- 确认ASK788芯片供电正常
- 验证脉冲时长是否符合芯片要求

### 5.2 档位切换异常
- 检查GPIO脉冲时长设置
- 确认ASK788芯片型号和规格
- 验证电源电压是否稳定

### 5.3 MCP工具调用失败
- 检查FanController是否正确初始化
- 确认MCP服务器正常运行
- 验证JSON-RPC消息格式

## 6. 扩展功能

### 6.1 定时控制
可以添加定时功能，例如：
```cpp
mcp_server.AddTool("self.fan.set_timer", 
                   "Set fan timer in minutes", 
                   PropertyList({
                       Property("minutes", kPropertyTypeInteger, 30, 1, 120)
                   }), 
                   [this](const PropertyList& properties) -> ReturnValue {
                       // 实现定时关闭功能
                       return true;
                   });
```

### 6.2 温度联动
可以添加温度传感器联动：
```cpp
mcp_server.AddTool("self.fan.auto_mode", 
                   "Enable auto mode based on temperature", 
                   PropertyList({
                       Property("enabled", kPropertyTypeBoolean, true)
                   }), 
                   [this](const PropertyList& properties) -> ReturnValue {
                       // 实现温度自动控制
                       return true;
                   });
```

## 7. 总结

这个风扇控制器实现完全模仿了LampController的设计模式，具有以下特点：

1. **标准化**: 使用MCP协议，与现有物联网架构兼容
2. **模块化**: 独立的FanController类，易于维护和扩展
3. **功能完整**: 支持开关、多档位、状态查询等功能
4. **硬件适配**: 针对ASK788芯片特性设计控制逻辑
5. **易于测试**: 提供完整的测试方法和故障排除指南

通过这个实现，你可以轻松地将风扇集成到现有的物联网系统中，实现智能控制。
